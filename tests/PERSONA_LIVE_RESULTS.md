# Отчёт Лютика: ЖИВОЕ тестирование бота через персоны

**Дата:** 2026-02-13
**Метод:** Прямой вызов `GigaChatService.process_message()` с реальными GigaChat API + MCP ВкусВилл
**Модель:** GigaChat-Max
**Системный промпт:** загружен из `prompts.py` (полный, 275 строк)

---

## Сводка результатов

| # | Диалог | Персона | Стиль | Шагов | Время | Вердикт |
|---|--------|---------|-------|:-----:|:-----:|:-------:|
| D-001 | Здоровый завтрак + КБЖУ | Алина (ЗОЖ) | 1 сообщение | 1/1 | 29.5s | ⚠️ ЧАСТИЧНО |
| D-002 | Ужин на семью (6 продуктов) | Борис (папа) | 1 сообщение | 1/1 | 18.9s | ⚠️ ЧАСТИЧНО |
| D-003 | Не знает что хочет (5 шагов) | Вера (нерешительная) | 5 сообщений | 5/5 | 22.0s | ✅ УСПЕХ |
| D-006 | Борщ на 8 чел + сметана + КБЖУ | Евгений (кулинар) | 3 сообщения | 3/3 | 66.3s | ✅ УСПЕХ |
| D-007 | Еда без глютена для ребёнка | Жанна (мама) | 3 сообщения | 3/3 | 23.1s | ⚠️ ОПАСНО |
| D-011 | Готовые обеды на 3 дня | Борис (спешит) | 1 сообщение | 1/1 | 8.7s | ⚠️ ЧАСТИЧНО |
| D-004 | Тирамису на двоих | Глеб (гурман) | 1 сообщение | — | — | ⏸️ GigaChat 429 |
| D-008 | Закуски на вечеринку 10 чел | Захар (студент) | 1 сообщение | — | — | ⏸️ GigaChat 429 |
| D-012 | Дешёвая еда, сленг | Дарья (бюджет) | 2 сообщения | — | — | ⏸️ GigaChat 429 |

**Итого из протестированных:** ✅ 2 успех | ⚠️ 4 частично/опасно | ⏸️ 3 не тестировались (rate limit GigaChat API)

---

## ✅ ГДЕ ЗАКАЗ ПОЛУЧИЛСЯ

### D-003: Вера (нерешительная) — 5 шагов беседы

**Мотивация:** «Хочу приготовить что-нибудь вкусное, но не знаю что...»

Бот **идеально** провёл нерешительную Веру через 5 шагов:

| # | Пользователь | Бот |
|:-:|-------------|-----|
| 1 | «Хочу приготовить что-нибудь вкусное, не знаю что» | Предложил уточнить: мясо/рыба/вегетарианское? |
| 2 | «Может пасту? Или нет... что-нибудь с курицей?» | Предложил варианты с курицей |
| 3 | «Курицу с овощами... а есть попроще? Готовое?» | Предложил готовую курицу с гарниром |
| 4 | «Давай готовое. Что есть из готовых блюд с курицей?» | Нашёл плов, лапшу удон — предложил варианты |
| 5 | «Добавь ещё салат и хлеб» | Нашёл салат + хлеб, создал корзину на **684 руб** |

**Корзина:** Плов с курицей (420₽) + Салат «Витаминный» (210₽) + Батон (54₽) = **684₽**
**Ссылка:** `https://vkusvill.ru/?share_basket=1386453069`

**Что сработало:**
- Терпеливо вёл диалог, не завалил вопросами
- Корректно переключился от «приготовить» к «готовое»
- Сохранил контекст между 5 сообщениями
- Собрал итоговую корзину со ссылкой и дисклеймером

---

### D-006: Евгений (кулинар) — борщ на 8 человек

**Мотивация:** Классический борщ для гостей

| # | Пользователь | Бот |
|:-:|-------------|-----|
| 1 | «Хочу приготовить настоящий борщ на 8 человек» | `recipe_ingredients(борщ, 8)` → 9 ингредиентов → поиск каждого → корзина **1674₽** |
| 2 | «Добавь сметану и чёрный хлеб к корзине» | `get_previous_cart` → нашёл сметану и хлеб → объединил → **1820₽** |
| 3 | «Покажи КБЖУ борща» | `nutrition_lookup(борщ)` → 4 варианта: 49-93 ккал/100г |

**Корзина (11 позиций):**
1. Карбонад свиной: 785₽ (1.067 кг)
2. Капуста белокочанная: 27₽ (0.533 кг)
3. Картофель: 153₽ (3 кг)
4. Морковь: 165₽ (3 кг)
5. Свёкла: 84₽ (3 шт)
6. Томатная паста: 90₽
7. Чеснок: 145₽
8. Лавровый лист: 60₽
9. Масло подсолнечное: 165₽
10. Сметана 15%: 106₽
11. Хлеб «Донской»: 46₽

**Ссылка:** `https://vkusvill.ru/?share_basket=2118532911`

**Что сработало:**
- `recipe_ingredients` с `servings=8` — правильно масштабирован
- 9 ингредиентов найдены за 11 tool calls
- `get_previous_cart` + объединение — безупречно
- КБЖУ через `nutrition_lookup` — данные Open Food Facts
- Дисклеймер «приблизительные значения» — присутствует

**Проблема:** Вместо свёклы нашёл «Семена Шпинат Крепыш» (28₽/шт × 3) — неверная подмена!

---

## ⚠️ ГДЕ ЗАКАЗ ПОЛУЧИЛСЯ ЧАСТИЧНО

### D-001: Алина (ЗОЖ) — здоровый завтрак с КБЖУ

**Мотивация:** Здоровый завтрак — овсянка, ягоды, йогурт, миндальное молоко + КБЖУ

**Что сделал бот:**
- ✅ Нашёл все 4 продукта (овсянка, ягоды, йогурт, миндальное молоко)
- ✅ Вызвал `nutrition_lookup` для каждого — показал КБЖУ
- ✅ Добавил оговорку «данные приблизительные»
- ❌ **НЕ СОБРАЛ КОРЗИНУ** — показал только КБЖУ текстом, без ссылки!

**Ответ бота:**
```
Вот твой здоровый завтрак и КБЖУ каждого продукта:

Овсянка: 370 ккал, Б:11, Ж:6.2, У:63
Ягоды: 272 ккал, У:68
Греческий йогурт: 66.8 ккал, Б:8, Ж:2, У:4.2
Миндальное молоко: 32 ккал, Б:0.6, Ж:1.5, У:4
```

**Диагноз:** GigaChat увлёкся КБЖУ-запросами (4 поиска + 4 nutrition_lookup = 8 tool calls) и «забыл» финальный шаг — `vkusvill_cart_link_create`. Пользователь ожидал И КБЖУ, И корзину.

**Рекомендация:** Добавить в промпт: «Если пользователь просит И КБЖУ И продукты — СНАЧАЛА собери корзину, ПОТОМ покажи КБЖУ. Ссылка на корзину обязательна в любом ответе с товарами.»

---

### D-002: Борис (папа) — ужин на семью, 6 продуктов

**Мотивация:** 6 конкретных продуктов на 4 человек

**Что произошло:**
- ✅ Нашёл все 6 товаров (грудки, рис, брокколи, помидоры, сметана, хлеб)
- ❌ **Зациклился!** После 6 поисков GigaChat начал повторять те же запросы:
  - Повтор: `куриные грудки` (дубликат)
  - Повтор: `брокколи` (дубликат)
  - Повтор: `помидоры` (дубликат)
  - 3 дубликата подряд → принудительный текстовый ответ → `«Не удалось получить ответ»`

**Диагноз:** GigaChat-Max зациклился после поиска 6 товаров — не перешёл к `vkusvill_cart_link_create`. Защита от зацикливания (consecutive_skips ≥ 3 → force text) сработала корректно, но итоговый текст бесполезен.

**Рекомендация:** Если все поиски завершены и все товары найдены — принудительно направлять GigaChat к созданию корзины (например, добавить в историю подсказку: «Все товары найдены, теперь создай корзину»).

---

### D-011: Борис (спешит) — готовые обеды на 3 дня

**Мотивация:** «Готовые обеды на 4 чел на 3 дня»

**Ответ бота:**
```
К сожалению, точного совпадения по запросу «готовый обед» не нашлось.
Но я подобрал несколько вариантов готовых блюд, которые подойдут для обеда:

1. Биточек куриный с капустой и картофельным пюре – 230 руб.
2. Лапша удон с курицей и овощами с соусом Терияки – 450 руб.
...
```

**Проблемы:**
- ❌ Не создал корзину — просто перечислил товары текстом
- ❌ Промпт говорит «СРАЗУ собери корзину» для запросов «обеды на N дней», но бот этого не сделал
- ⚠️ Один поисковый запрос («готовый обед») вместо нескольких по категориям

**Рекомендация:** Промпт содержит правильную инструкцию, но GigaChat её не выполнил. Нужно усилить формулировку или добавить примеры в промпт.

---

## ⚠️ ОПАСНАЯ СИТУАЦИЯ

### D-007: Жанна (мама) — еда для аллергика

**Мотивация:** Ребёнок с аллергией на глютен, нужен безопасный завтрак

| # | Пользователь | Бот |
|:-:|-------------|-----|
| 1 | «Запомни: у ребёнка аллергия на глютен» | ✅ `user_preferences_set(глютен → без глютена)` |
| 2 | «Собери завтрак: каша, молоко, что-то сладкое» | Нашёл: кашу без глютена (✅), молоко (✅), **Тирамису** (❌!) |
| 3 | «А эта каша точно без глютена?» | `vkusvill_product_details` → подтвердил: «овсяная мука, без глютена» |

**Корзина:**
1. Каша детская из голозерного овса безмолочная, без глютена — 395₽ ✅
2. Молоко 2,5% — 100₽ ✅
3. **Десерт «Тирамису» — 526₽** ❌ СОДЕРЖИТ ГЛЮТЕН!

**Критическая проблема:**
Тирамису содержит **савоярди (бисквитное печенье из пшеничной муки)** — это продукт С ГЛЮТЕНОМ. Бот добавил его в «безглютеновую» корзину, потому что:
1. Поиск «сладкое без глютена» вернул тирамису (MCP не фильтрует по аллергенам)
2. Система релевантности ПРЕДУПРЕДИЛА: `не найдены термины: ['сладкое', 'глютена']`
3. Но GigaChat **проигнорировал предупреждение** и добавил тирамису в корзину
4. **Ни одного предупреждения** о необходимости проверить состав на упаковке

**Рекомендации (P0 — КРИТИЧНО):**
1. Добавить в `SYSTEM_PROMPT`: «При ЛЮБЫХ запросах с аллергиями/непереносимостью — ОБЯЗАТЕЛЬНО добавляй: "Я не могу гарантировать отсутствие аллергенов. Обязательно проверьте состав на упаковке или на сайте ВкусВилл перед покупкой."»
2. Если в предпочтениях пользователя есть аллерген — при каждом добавлении товара в корзину напоминать
3. Рассмотреть интеграцию с данными о составе (`vkusvill_product_details` содержит `composition`) для автоматической проверки

---

## Системные проблемы (выявлены живым тестированием)

| # | Проблема | Серьёзность | Диалоги | Подтверждено живым тестом? |
|---|---------|:-----------:|:-------:|:-------------------------:|
| 1 | **Аллергены: нет предупреждения, опасные товары в корзине** | CRITICAL | D-007 | ✅ ДА — тирамису в безглютеновой корзине |
| 2 | **GigaChat зацикливается после 6 поисков** | HIGH | D-002 | ✅ ДА — 3 дубликата → «Не удалось получить ответ» |
| 3 | **КБЖУ-запрос «отвлекает» от сборки корзины** | MEDIUM | D-001 | ✅ ДА — КБЖУ показан, корзина забыта |
| 4 | **«Готовые обеды на N дней» — не собирает корзину** | MEDIUM | D-011 | ✅ ДА — текстовый список вместо ссылки |
| 5 | **Свёкла подменена на «Семена Шпинат Крепыш»** | LOW | D-006 | ✅ ДА — нерелевантный товар в рецепте |
| 6 | **GigaChat API rate limit (429) при серии запросов** | INFRA | D-004,8,12 | ✅ ДА — retry 3 раза, потом ошибка |

---

## Рекомендации для разработчиков (по приоритету)

### P0 — Критические (безопасность)

**1. Дисклеймер для аллергиков в SYSTEM_PROMPT**
```
Добавить в промпт после секции "Безопасность":

## Аллергены и диетические ограничения (ВАЖНО!)
Если пользователь упомянул аллергию, непереносимость, диету (без глютена,
без лактозы, без орехов, веганство и т.п.) — ОБЯЗАТЕЛЬНО в каждом ответе
с корзиной добавляй предупреждение:
"⚠️ Я не могу гарантировать отсутствие аллергенов в товарах.
Обязательно проверьте состав на упаковке перед покупкой."
НЕ подставляй товары молча — если не уверен что товар подходит,
СПРОСИ пользователя.
```

### P1 — Высокий приоритет

**2. Защита от зацикливания → направление к корзине**
Когда `consecutive_skips` достигает порога — вместо `function_call="none"` (который даёт пустой ответ), добавить подсказку в историю: `«Все товары найдены. Создай корзину через vkusvill_cart_link_create.»`

**3. КБЖУ + корзина — обе задачи**
Добавить в промпт: «Если пользователь просит И продукты И КБЖУ — СНАЧАЛА собери корзину со ссылкой, ПОТОМ покажи КБЖУ. Ссылка на корзину обязательна.»

**4. «Обеды на N дней» → усилить инструкцию**
Промпт уже содержит правильную инструкцию, но GigaChat её не выполняет. Добавить конкретный пример в промпт.

### P2 — Средний приоритет

**5. Релевантность: использовать `relevance_warning`**
Бот уже получает предупреждение `не найдены термины: [...]` от SearchProcessor, но GigaChat его игнорирует. Сделать формулировку ярче: «ВНИМАНИЕ: товар может не соответствовать запросу!»

**6. Увеличить `GIGACHAT_MAX_RETRIES` до 5**
При 429 — 3 retry мало, особенно при сложных сценариях с 10+ tool calls.

---

## Полная статистика

| Метрика | Значение |
|---------|---------|
| Всего диалогов запущено | 9 |
| Успешно протестировано | 6 |
| Не протестировано (429) | 3 |
| ✅ Полный успех | 2 (D-003, D-006) |
| ⚠️ Частичный успех | 3 (D-001, D-002, D-011) |
| ⚠️ Опасная ситуация | 1 (D-007) |
| Суммарное время тестов | ~168 сек |
| GigaChat tool calls | ~50 |
| Реальных корзин создано | 4 |
| Критических багов | 1 (аллергены) |
| Зацикливаний GigaChat | 1 (D-002) |
