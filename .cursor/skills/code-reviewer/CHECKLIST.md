# Чеклисты ревью кода

## Быстрый чеклист (для каждого файла)

```
- [ ] Type hints на всех функциях
- [ ] Docstring у публичных функций
- [ ] Нет print() / breakpoint()
- [ ] Нет закомментированного кода
- [ ] Ошибки обрабатываются (try/except с конкретными типами)
- [ ] Логирование через logger, не print
- [ ] Нет захардкоженных секретов
```

## Полный чеклист ревью

### 1. Архитектура

```
- [ ] Код в правильном слое (handlers / services / config)
- [ ] Нет прямых вызовов внешних API из handlers
- [ ] Dependency injection соблюдён
- [ ] Нет циклических зависимостей
- [ ] Нет дублирования функциональности
- [ ] Принципы SOLID не нарушены
- [ ] Новые модули следуют существующей структуре
```

### 2. Async/Await

```
- [ ] Все I/O-операции асинхронные
- [ ] await для всех async-вызовов
- [ ] asyncio.sleep() вместо time.sleep()
- [ ] async with для контекстных менеджеров
- [ ] Нет блокирующих вызовов (requests, open для больших файлов)
- [ ] httpx.AsyncClient вместо requests
```

### 3. Типизация

```
- [ ] Аннотации всех параметров
- [ ] Аннотация возвращаемого значения
- [ ] Optional[T] для nullable
- [ ] Корректные generic-типы (list[str], dict[str, Any])
- [ ] Нет использования Any без необходимости
```

### 4. Обработка ошибок

```
- [ ] Конкретные типы исключений
- [ ] Нет голых except: / except Exception:
- [ ] Нет проглатывания исключений (except: pass)
- [ ] Логирование ошибок с контекстом
- [ ] Пользователь получает понятное сообщение
- [ ] Ресурсы освобождаются (async with, try/finally)
- [ ] Retry-логика где необходимо
```

### 5. Безопасность

```
- [ ] Нет захардкоженных секретов (токены, ключи, пароли)
- [ ] Нет опасных функций (eval, exec, pickle.loads, os.system)
- [ ] Пользовательский ввод валидируется
- [ ] Секреты не попадают в логи
- [ ] SSL-сертификаты проверяются
- [ ] Нет SQL/command injection
- [ ] .env не в git-репозитории
- [ ] Лимиты настроены (tool_calls, history, message length)
```

### 6. AI-безопасность (для GigaChat-сервиса)

```
- [ ] Системный промпт не раскрывается
- [ ] Лимит на tool_calls (защита от бесконечных циклов)
- [ ] Детекция циклов в вызовах инструментов
- [ ] Обрезка истории при превышении лимита
- [ ] Инструменты вызываются только с валидными параметрами
```

### 7. MCP-клиент

```
- [ ] JSON-RPC 2.0 корректно реализован
- [ ] Retry с экспоненциальным backoff
- [ ] Таймауты настроены
- [ ] Невалидный JSON обрабатывается
- [ ] Кэширование инструментов работает
- [ ] Persistent connection с keep-alive
```

### 8. Тесты

```
- [ ] Новый код покрыт тестами
- [ ] Моки для внешних сервисов
- [ ] Паттерн Arrange-Act-Assert
- [ ] Edge cases покрыты (пустые строки, длинные сообщения)
- [ ] Тесты изолированы друг от друга
- [ ] Нет зависимости от внешних сервисов в тестах
- [ ] Покрытие >= 80%
```

### 9. Документация

```
- [ ] Docstrings у публичных функций (Google-style)
- [ ] Комментарии для неочевидной логики
- [ ] README обновлён (если нужно)
- [ ] CHANGELOG обновлён (для новых версий)
```

### 10. Git и стиль

```
- [ ] Коммиты в формате Conventional Commits
- [ ] Ветка именована по правилам (feature/, fix/, etc.)
- [ ] PR имеет описание по шаблону
- [ ] Нет мусорных файлов (.pyc, __pycache__, .DS_Store)
- [ ] Нет конфликтов с main
```

## Чеклист по компонентам

### handlers.py

```
- [ ] Команды зарегистрированы через Router
- [ ] Typing action для длительных операций
- [ ] Длинные сообщения разделяются (лимит 4096)
- [ ] Ошибки перехватываются и пользователь информируется
- [ ] Нет бизнес-логики — только делегация в services
```

### gigachat_service.py

```
- [ ] Per-user история сообщений
- [ ] Лимит tool_calls соблюдён
- [ ] Обрезка истории при превышении лимита
- [ ] Системный промпт корректный
- [ ] Детекция циклов в tool calls
- [ ] Кэширование описаний инструментов
```

### mcp_client.py

```
- [ ] SSE-ответы парсятся корректно
- [ ] Retry-логика с backoff
- [ ] Таймауты настроены
- [ ] Валидация аргументов инструментов
- [ ] Persistent HTTP-соединение
- [ ] Корректная JSON-RPC 2.0 реализация
```

### config.py

```
- [ ] Все секреты через env-переменные
- [ ] Значения по умолчанию безопасны
- [ ] Лимиты разумны
- [ ] Валидация значений через pydantic
```
