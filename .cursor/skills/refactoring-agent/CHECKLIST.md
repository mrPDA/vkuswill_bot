# Чеклисты рефакторинга

## Быстрый чеклист (перед каждым рефакторингом)

```
- [ ] Тесты проходят ДО начала рефакторинга
- [ ] Изменения не затрагивают публичный API (или согласованы)
- [ ] Каждая трансформация — атомарная и обратимая
- [ ] Тесты проходят ПОСЛЕ рефакторинга
- [ ] Нет новых линтер-ошибок
```

---

## Полный чеклист по категориям

### 1. Структура и сложность

```
- [ ] Нет методов > 50 строк (Long Method)
- [ ] Нет классов > 300 строк (God Class)
- [ ] Максимальная вложенность <= 3 уровня
- [ ] Цикломатическая сложность метода <= 10
- [ ] Каждый метод делает одну вещь (SRP на уровне метода)
- [ ] Каждый класс — одна зона ответственности (SRP на уровне класса)
- [ ] Нет методов с > 4 параметрами
```

### 2. Дублирование

```
- [ ] Нет copy-paste блоков (> 3 строк одинакового кода)
- [ ] Общая логика вынесена в shared-методы
- [ ] Повторяющиеся паттерны JSON-парсинга вынесены в утилиты
- [ ] Нет дублирования проверок / валидаций
```

### 3. Нейминг и читаемость

```
- [ ] Имена переменных описывают содержимое (не x, temp, data)
- [ ] Имена функций описывают действие (глагол + объект)
- [ ] Булевы переменные — is_/has_/can_ (is_valid, has_items)
- [ ] Нет однобуквенных переменных (кроме i, j в коротких циклах)
- [ ] Нет аббревиатур без контекста (прев → preferences, опис → description)
- [ ] Нет негативных условий (not is_invalid → is_valid)
```

### 4. Магические значения

```
- [ ] Нет магических чисел (числа без пояснения)
- [ ] Нет магических строк (строки-ключи без констант)
- [ ] Все лимиты — именованные константы
- [ ] Константы объявлены на уровне модуля или класса
- [ ] Константы имеют docstring или комментарий
```

### 5. Мёртвый код

```
- [ ] Нет неиспользуемых импортов
- [ ] Нет неиспользуемых переменных
- [ ] Нет неиспользуемых функций / методов
- [ ] Нет закомментированного кода
- [ ] Нет TODO без issue-номера (устаревшие TODO)
- [ ] Нет print() / breakpoint() в продакшн-коде
```

### 6. Обработка ошибок

```
- [ ] Конкретные типы исключений (не except Exception)
- [ ] Нет проглатывания исключений (except: pass)
- [ ] Ошибки логируются с контекстом
- [ ] Ресурсы освобождаются (async with, try/finally)
- [ ] Retry-логика с backoff для сетевых операций
- [ ] Таймауты установлены на все внешние вызовы
```

### 7. Типизация

```
- [ ] Type hints на всех параметрах функций
- [ ] Type hints на возвращаемых значениях
- [ ] Атрибуты класса типизированы
- [ ] Используется T | None вместо Optional[T] (Python 3.11+)
- [ ] Нет Any без необходимости
- [ ] Сложные типы вынесены в TypeAlias
```

### 8. Async-корректность

```
- [ ] Нет блокирующих вызовов в async-функциях
- [ ] asyncio.to_thread() для синхронных SDK
- [ ] async with для контекстных менеджеров ресурсов
- [ ] asyncio.gather() для независимых конкурентных задач
- [ ] Нет time.sleep() — только asyncio.sleep()
- [ ] Нет requests — только httpx.AsyncClient
```

### 9. Архитектура

```
- [ ] Код в правильном слое (handlers → services → external)
- [ ] Dependency injection соблюдён (нет глобальных singleton)
- [ ] Нет циклических зависимостей
- [ ] Принцип Open/Closed — расширение без модификации
- [ ] Принцип Liskov — подтипы заменяемы
- [ ] Принцип Interface Segregation — минимальные интерфейсы
- [ ] Принцип Dependency Inversion — зависимости от абстракций
```

### 10. Документация (после рефакторинга)

```
- [ ] Docstrings на всех новых публичных методах (Google-style)
- [ ] Docstrings на новых классах — описание ответственности
- [ ] Комментарии для неочевидной логики обновлены
- [ ] Удалены устаревшие комментарии
- [ ] Сигнатуры корректны в type stubs (если есть)
```

---

## Чеклист по файлам проекта

### gigachat_service.py

```
- [ ] process_message() разбит на методы <= 50 строк
- [ ] JSON-парсинг вынесен в общие утилиты
- [ ] Кеширование цен — отдельный класс/модуль
- [ ] Верификация корзины — отдельный класс/модуль
- [ ] Обработка инструментов — dispatch вместо if/elif
- [ ] Inline-импорты (copy, math) вынесены на верхний уровень
- [ ] Магические числа → именованные константы
- [ ] Тесты покрывают все извлечённые методы
```

### handlers.py

```
- [ ] Нет бизнес-логики — только делегация в services
- [ ] Ошибки перехватываются с пользователем-friendly сообщениями
- [ ] typing action отправляется для длительных операций
- [ ] Длинные ответы разделяются (лимит Telegram 4096)
- [ ] Логирование без персональных данных
```

### mcp_client.py

```
- [ ] Retry-логика с экспоненциальным backoff
- [ ] Таймауты на все запросы
- [ ] Невалидный JSON обрабатывается gracefully
- [ ] Кеширование описаний инструментов
- [ ] Persistent HTTP-соединение (keep-alive)
```

### config.py

```
- [ ] Все секреты через env-переменные
- [ ] Значения по умолчанию безопасны
- [ ] Валидация через pydantic validators
- [ ] Нет import-time side effects
```

---

## Метрики качества рефакторинга

| Метрика | Порог | Как измерить |
|---------|-------|-------------|
| Макс. строк в методе | <= 50 | Визуально / pylint |
| Макс. строк в классе | <= 300 | `wc -l` |
| Макс. вложенность | <= 3 | Визуально / radon |
| Цикломатическая сложность | <= 10 | `radon cc -s` |
| Покрытие тестами | >= 80% | `pytest --cov` |
| Дублирование | < 5% | `jscpd` / PMD CPD |
| Неиспользуемый код | 0 | `vulture` / ruff |
| Type coverage | >= 90% | `mypy --stats` |

---

## Метрики ДО и ПОСЛЕ (шаблон)

```markdown
| Метрика | До | После | Δ |
|---------|-----|-------|---|
| Строк в файле | | | |
| Строк в макс. методе | | | |
| Макс. вложенность | | | |
| Кол-во методов | | | |
| Кол-во классов | | | |
| Магических чисел | | | |
| Дублированных блоков | | | |
| Покрытие тестами | | | |
| Тесты | ✅ / ❌ | ✅ / ❌ | |
```
