# Changelog

Все значимые изменения проекта документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/),
версионирование следует [Semantic Versioning](https://semver.org/).

## [0.8.0] — 2026-02-14

### Добавлено

- **Анонимизация ПДн** — прекращена запись `username`, `first_name`, `last_name` в таблицу `users`; для работы бота и поддержки достаточно `user_id`
- **Миграция 006** — очистка существующих персональных данных в БД (`006_anonymize_pii.sql`)
- **Скрипт настройки Metabase-дашбордов** — автоматизация создания дашбордов через Metabase API (`scripts/setup_metabase_dashboards.py`)

### Изменено

- **UserStore.get_or_create()** — убраны параметры PII, upsert работает только с `user_id` и `language_code`
- **UserStore.ensure_admins()** — убрано `first_name = 'Admin'` из INSERT
- **/admin_user** — убран вывод username/имени, добавлена статистика корзин
- **Metabase-дашборд** — `user_id` вместо `COALESCE(username, first_name)` в карточке «Топ-пользователи»

## [0.7.0] — 2026-02-14

### Добавлено

- **Metabase BI-дашборды на production** — Terraform: PG user/database `metabase`, Security Group порт 3001, Lockbox секреты `METABASE_ENABLED` и `METABASE_DATABASE_URL`
- **deploy_metabase() в deploy.sh** — автоматический деплой контейнера `metabase/metabase:v0.58` на VM через CD pipeline (по аналогии с Langfuse)
- **CD pipeline: поддержка Metabase** — fallback env-переменные, диагностика контейнера в логах деплоя

## [0.6.0] — 2026-02-14

### Добавлено

- **Реферальная система** — команда `/invite` для генерации персональной реферальной ссылки, начисление бонусных корзин рефереру при регистрации нового пользователя, уведомление реферера о присоединении друга
- **Deep-link ref\_\<code\>** — обработка строковых реферальных кодов при `/start` (обратная совместимость с числовыми user\_id)
- **UserStore: реферальные методы** — `get_or_create_referral_code()`, `find_user_by_referral_code()`, `process_referral()`, `count_referrals()`
- **14 новых/обновлённых тестов** — покрытие реферальной системы, дифференцированных сообщений, атрибуции source

### Улучшено

- **Дифференцированные сообщения при исчерпании лимита** — Tier 1 (опрос не пройден): предложение `/survey`; Tier 2 (опрос пройден): предложение `/invite`
- **Корректная атрибуция source** — `source=organic` при невалидных реферальных кодах (ранее ошибочно `referral`)
- **Защитная проверка `message.bot`** — предотвращение `AttributeError` в `/invite` при `bot is None`

## [0.5.22] — 2026-02-14

### Исправлено

- **Объединение 2 корзин в одну** — после успешного создания корзины (`vkusvill_cart_link_create ok:true`) следующий вызов GigaChat принудительно текстовый (`function_call=none`), чтобы модель не продолжала собирать товары из предыдущих запросов в истории
- **Ошибка 422 при обрезке истории** — при `trim_list` финальный срез мог разорвать пару ASSISTANT(function_call) + FUNCTION, оставляя осиротевшее FUNCTION-сообщение. Добавлена санитизация `_sanitize_history()` после каждой обрезки (DialogManager, RedisDialogManager)

## [0.5.21] — 2026-02-14

### Исправлено

- **Диспетчеризация суммаризатора tool results** — OR-условия (`name == "tool" or "key" in data`) заменены на двухуровневую диспетчеризацию: точное совпадение по `name` (приоритет) → эвристика по ключам JSON (только если `name is None`). Устранена некорректная суммаризация при пересечении ключей между инструментами

### Добавлено

- 19 тестов на диспетчеризацию `_summarize_tool_result`, включая 3 регрессионных теста с «ключами-ловушками»

## [0.5.20] — 2026-02-14

### Исправлено

- **GigaChat 422 «invalid function result json string»** — freemium-хинт `[Корзина X из Y]` дописывался как plain-text к JSON-результату корзины, ломая валидность JSON для GigaChat API. Теперь хинт встраивается внутрь JSON-структуры (`data.freemium`)
- **HTML-сущности в названиях товаров** — `&nbsp;` из MCP-сервера заменяется на пробел в price_summary, `×` → `x` для совместимости с JSON-парсером GigaChat

## [0.5.15] — 2026-02-13

### Улучшено

- **X-Session-ID кеширование** — prefix-токены (system prompt + tools) кешируются между API-вызовами через `session_id_cvar`, ожидаемая экономия ~50-65% оплачиваемых токенов
- **Оптимизация SYSTEM_PROMPT** — удалены дубли, сжаты секции «Соленья», «Расчёт количества», «Алкоголь», «Анти-галлюцинация» (−15.4%, −579 токенов overhead)
- **Умная обрезка истории** — старые FUNCTION-сообщения суммаризируются при trim (вместо ~1000 токенов → ~30 токенов за tool result)
- **Сокращение recipe hint** — ~500→~120 символов (дубли перенесены в SYSTEM_PROMPT)
- **Расширенное логирование токенов** — `precached_tokens`, `billable_tokens` в structured logs и Langfuse metadata

## [0.5.14] — 2026-02-13

### Исправлено

- **deploy.sh** — добавлен `sudo` для `chown DATA_DIR` (deploy-пользователь не может менять владельца файлов, созданных контейнером)

## [0.5.13] — 2026-02-13

### Добавлено

- **MigrationRunner** — версионированная система SQL-миграций (заменяет `ensure_schema()`), отслеживает применённые миграции в таблице `schema_migrations`
- **StatsAggregator** — фоновая агрегация `user_events → daily_stats` (DAU, новые пользователи, сессии) с периодом 1 час
- **Survey flow** — опрос для получения бонусных корзин (freemium-модель): `/survey`, inline-кнопки, `SURVEY_BONUS_CARTS` в конфиге
- **Deep link tracking** — `/start habr`, `/start ref_123`, `/start vc` — атрибуция источника трафика через `user_events`
- **Лимиты корзин** — `FREE_CART_LIMIT` / `SURVEY_BONUS_CARTS` в config, проверка в `ToolExecutor`
- **Admin-команды аналитики** — `/admin_analytics [N]`, `/admin_funnel [N]` с агрегированными данными
- **UserStore: расширенные методы** — `log_event()`, `get_cart_count()`, `get_events()`, `complete_survey()`, admin-статистика
- **Metabase** — BI-дашборды в `docker-compose.yml` для локальной аналитики (daily_stats, user_events, users)
- **SQL-миграции** — `003_daily_stats`, `004_add_cart_limits`, `005_add_user_events_index`

### Изменено

- **Dockerfile** — фиксированный UID/GID 10001 для предсказуемых прав на файловую систему
- **deploy.sh** — `chown 10001:10001` + `chmod 750` вместо `chmod a+rwx` (безопасность DATA_DIR)

### Исправлено

- **ruff lint** — SIM105, RUF059, F401, E501, SIM102 в коде и тестах (включая pre-existing в persona_live_test)

## [0.5.12] — 2026-02-13

### Исправлено

- **force_text не срабатывал после подсказки о корзине** — `consecutive_skips` сбрасывался в 0 после инъекции подсказки, из-за чего для принудительного текстового ответа требовалось ещё 3 дубликата вместо 1; теперь сбрасывается в `max_consecutive_skips - 1`, и уже следующий дубликат включает force_text

## [0.5.11] — 2026-02-12

### Добавлено

- **КБЖУ-сервис (nutrition_lookup)** — новый инструмент для получения калорий, белков, жиров и углеводов на 100 г через Open Food Facts API (бесплатный, без API-ключа, доступен из РФ). Поддерживает русский язык, содержит ~30K русских продуктов включая ВкусВилл
- **Секция «Планирование питания на N дней»** в системном промпте — бот делает несколько поисков по категориям (суп, второе, салат), выбирает разнообразные блюда и сразу собирает корзину
- **Секция «КБЖУ и калорийность»** в системном промпте — бот использует nutrition_lookup для фильтрации по ккал, не выдумывает калорийность

## [0.5.8] — 2026-02-12

### Исправлено

- **GigaChat путал граммы рецепта с количеством упаковок** — `q=170` для пачки сахара 1 кг (= 170 кг!), `q=250` для бутылки молока 2 л (= 250 бутылок); добавлен вес упаковки (`weight_value`/`weight_unit`) в PriceInfo, умный пересчёт в `fix_unit_quantities`: `q = ceil(граммы_рецепта / вес_упаковки)` (170г / 1000г = 1 пачка)
- **PriceCache теперь хранит вес упаковки** — вес из search results (`weight: {value, unit}`) сохраняется в L1 (in-memory) и L2 (Redis), используется для валидации q

## [0.5.7] — 2026-02-12

### Исправлено

- **Яйца считались упаковками** — GigaChat ставил q=2 для 2 яиц (= 2 упаковки по 10 = 20 яиц за 444 руб); добавлен `pack_equivalent` в рецепты и cap q=1 для яиц в cart_processor
- **Лишние ингредиенты в рецепте** — GigaChat добавлял от себя «сливки 33%» (→ кокосовое молоко) к Наполеону; усилен запрет на добавление ингредиентов не из списка

## [0.5.6] — 2026-02-12

### Исправлено

- **Смешивание рецептов при переключении блюд** — GigaChat вызывал get_previous_cart во время рецептного flow, подмешивая ингредиенты старого рецепта (Оливье) в новый (Наполеон); добавлен запрет get_previous_cart в режиме рецепта

## [0.5.5] — 2026-02-12

### Исправлено

- **Анти-галлюцинация в системном промпте** — GigaChat выдумывал цены и ссылки на корзину без вызова инструментов; добавлены строгие правила в system prompt: обязательная последовательность поиск → корзина, запрет на генерацию цен/ссылок без tool calls
- **Регрессия hint recipe_ingredients** — запретительная формулировка hint заставляла GigaChat пропускать поиск и корзину целиком; переписан на директивную формулировку
- **Конвертация г→кг и мл→л в рецептах** — `_enrich_with_kg` теперь добавляет `kg_equivalent` и `l_equivalent` для ингредиентов в граммах/мл (200 г → 0.2 кг), чтобы GigaChat не путал граммы с количеством
- **Качество извлечения рецептов** — RECIPE_EXTRACTION_PROMPT усилен: минимум 6-8 ингредиентов для выпечки, минимум 4-6 для основных блюд

## [0.5.0] — 2026-02-12

### Добавлено

- **Langfuse LLM-observability** — трейсинг всех вызовов GigaChat (trace → generation → span)
- **Self-hosted Langfuse** — контейнер на VM рядом с ботом, данные в РФ (Yandex Cloud)
- **Анонимизация** — SHA-256 хеш user_id, автоматическая маскировка PII (телефоны, email, карты)
- **Terraform: Langfuse DB** — БД `langfuse` + пользователь в существующем Managed PostgreSQL
- **Lockbox: Langfuse секреты** — DATABASE_URL, NEXTAUTH_SECRET, SALT
- **Nginx: Langfuse UI** — проксирование через `/langfuse/` (HTTPS)
- **docker-compose: Langfuse** — self-hosted для локальной разработки
- **No-Op трейсинг** — нулевой оверхед когда Langfuse отключён
- **Промпты** — улучшены инструкции для корзины и рецептов
- **SSL** — самоподписанный сертификат для Telegram webhook + nginx reverse proxy
- **Тесты** — расширено покрытие до 1231 теста (S3LogHandler, промпты, конфигурация)

### Исправлено

- CD pipeline — S3 log переменные, GIGACHAT_MODEL, docker login, .env provisioning
- Deploy script — обработка отсутствия yc CLI и ошибок Lockbox

## [0.4.0] — 2026-02-11

### Добавлено

- **Async Cart Processor** — переход CartProcessor и ToolExecutor на async API
- **Двухуровневый кэш цен** — L1 in-memory + L2 Redis для PriceCache
- **Снимки корзины** — CartSnapshotStore сохраняет корзины в Redis
- **Async DialogManager** — асинхронный API и Redis-бэкенд для диалогов
- **CD Pipeline** — GitHub Actions workflow для автоматического деплоя на Yandex Cloud VM
- **Deploy-скрипт** — deploy.sh с Lockbox-секретами, Docker, health check
- **S3 логирование** — S3LogHandler для отправки логов в Yandex Object Storage (NDJSON)
- **Dockerfile** — multi-stage build, оптимизированный для production
- **docker-compose.yml** — локальная среда с Redis и PostgreSQL
- **Dependabot** — автообновление pip-зависимостей и GitHub Actions
- **Terraform** — инфраструктура Yandex Cloud (VM, CR, Redis, PostgreSQL, Lockbox, S3)
- **Система пользователей** — UserStore и UserMiddleware для управления пользователями
- **Admin-команды** — управление пользователями через Telegram
- **Load-тесты** — Locust + Telethon для нагрузочного тестирования
- **Миграции БД** — SQL-миграции для PostgreSQL
- **Семафор GigaChat** — ограничение параллельных запросов (15 по умолчанию)
- **Retry 429** — автоматический retry при rate-limiting от GigaChat API
- **Тесты** — расширено покрытие до 1141 теста

### Исправлено

- CI pipeline — корректная валидация merge-коммитов
- Ruff — игнорирование RUF001/RUF002/RUF003 для кириллицы
- Bandit B104 — nosec для webhook bind 0.0.0.0
- Импорт SYSTEM_PROMPT после переноса в prompts.py
- cryptography 46.0.4 → 46.0.5 (CVE-2026-26007)

### Изменено

- GigaChat God Class декомпозирован на 4 модуля (prompts, cart_processor, search_processor, tool_executor)
- MCP-клиент очищен, PriceCache выделен в отдельный модуль
- Безопасность усилена — HTML-санитизация, rate-limiter, хранилища
- Документация перенесена в docs/

## [0.3.0] — 2026-02-08

### Добавлено

- **Извлечение ингредиентов рецепта** — инструмент `recipe_ingredients` для GigaChat, автоматически разбивает блюдо на ингредиенты с расчётом количества
- **RecipeStore** — SQLite-кеш рецептов с TTL для ускорения повторных запросов
- **RECIPE_EXTRACTION_PROMPT** — специализированный промпт для извлечения ингредиентов из LLM
- **Расчёт количества по рецепту** — инструкции в системном промпте для корректного расчёта q с учётом размеров упаковок
- **ROADMAP** — план развития бота (публичный и технический)
- **Черновик статьи для Хабра** — articles/01-hook.md
- **Тесты** — расширено покрытие до 669 тестов (RecipeStore, промпты, GigaChat edge-cases, SearchProcessor, CartProcessor, Handlers, MCP Client)

### Исправлено

- Обработка `price_info` в SearchProcessor — защита от не-dict значений
- `.cursorignore` для корректной работы IDE

### Изменено

- `max_tool_calls` увеличен с 15 до 20 для поддержки рецептов с большим числом ингредиентов
- Системный промпт расширен инструкциями по работе с рецептами и расчёту количества

## [0.2.0] — 2026-02-06

### Добавлено

- **GigaChat интеграция** — ИИ-оркестрация с function calling для поиска товаров и сборки корзин
- **MCP-клиент** — JSON-RPC клиент для взаимодействия с MCP-сервером ВкусВилл (поиск, детали товаров, создание корзины)
- **Хранилище предпочтений** — SQLite-хранилище (aiosqlite) для запоминания вкусовых предпочтений пользователей
- **ThrottlingMiddleware** — rate limiting: 5 сообщений / 60 секунд на пользователя
- **Команда /reset** — сброс истории диалога
- **Верификация корзины** — автоматическая проверка, что все запрошенные товары попали в корзину
- **Кэширование цен** — цены из результатов поиска кэшируются для расчёта стоимости
- **Защита от зацикливания** — детекция повторных вызовов одних и тех же инструментов
- **CI/CD** — GitHub Actions для тестирования (Python 3.11–3.13), линтинга и автоматических релизов
- **Git hooks** — валидация Conventional Commits и запуск тестов перед push
- **Makefile** — утилиты разработки (install, test, lint, format, run)
- **Тесты безопасности** — SAST, AI Safety (prompt injection, jailbreak), Config Security, Input Validation
- **Шаблоны GitHub** — Issue templates (bug report, feature request), PR template

### Изменено

- Полностью переработан README.md с документацией функционала, архитектуры и инструкциями

## [0.1.0] — 2026-02-05

### Добавлено

- Инициализация проекта
- Базовая структура Telegram-бота на aiogram 3
- Конфигурация через pydantic-settings
