# ============================================================
# CD Pipeline — Deploy to Yandex Cloud
# ============================================================
# Триггер: push тега v*.*.* (после успешного CI)
# Пайплайн: Build → Push to Yandex CR → SSH Deploy → Health Check → Notify
# ============================================================

name: CD

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to deploy (e.g. v0.4.0)"
        required: true

permissions:
  contents: read

env:
  CR_REGISTRY: cr.yandex/${{ secrets.YC_CR_REGISTRY_ID }}
  IMAGE_NAME: vkuswill-bot
  DEPLOY_USER: deploy
  DEPLOY_DIR: /opt/vkuswill-bot

jobs:
  # ─── 1. Тесты (быстрая проверка перед деплоем) ────────────────
  test:
    name: Pre-deploy tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - run: uv python install 3.12

      - run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest -x -q --tb=short

  # ─── 2. Сборка и push Docker-образа ───────────────────────────
  build-and-push:
    name: Build & Push to Yandex CR
    runs-on: ubuntu-latest
    needs: test
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}
      full_image: ${{ steps.meta.outputs.full_image }}

    steps:
      - uses: actions/checkout@v4

      - name: Extract tag
        id: meta
        run: |
          TAG="${{ github.event.inputs.tag || github.ref_name }}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${CR_REGISTRY}/${IMAGE_NAME}:${TAG}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Yandex Container Registry
        run: |
          echo "${{ secrets.YC_CR_KEY_SECRET }}" | \
            docker login cr.yandex \
              --username "${{ secrets.YC_CR_KEY_ID }}" \
              --password-stdin

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta.outputs.full_image }}
            ${{ env.CR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        run: echo "Pushed ${{ steps.meta.outputs.full_image }}"

  # ─── 3. Деплой на VM через SSH ────────────────────────────────
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.VM_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Copy deploy script
        run: |
          scp -i ~/.ssh/deploy_key \
            deploy/deploy.sh \
            "${{ env.DEPLOY_USER }}@${{ secrets.VM_HOST }}:${DEPLOY_DIR}/deploy.sh"

      - name: Run deploy
        env:
          FULL_IMAGE: ${{ needs.build-and-push.outputs.full_image }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          LOCKBOX_SECRET_ID: ${{ secrets.LOCKBOX_SECRET_ID }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            "${{ env.DEPLOY_USER }}@${{ secrets.VM_HOST }}" \
            "bash ${DEPLOY_DIR}/deploy.sh \
              --image '${FULL_IMAGE}' \
              --tag '${IMAGE_TAG}' \
              --lockbox '${LOCKBOX_SECRET_ID}'"

      - name: Health check
        run: |
          echo "Ожидание запуска бота (30 сек)..."
          sleep 30
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              "http://${{ secrets.VM_HOST }}:8080/health" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check OK (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: status=$STATUS, retrying in 10s..."
            sleep 10
          done
          echo "::warning::Health check failed after 5 attempts"

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/deploy_key

  # ─── 4. Уведомление в Telegram ────────────────────────────────
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()

    steps:
      - name: Send Telegram notification
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          TAG: ${{ needs.build-and-push.outputs.image_tag }}
          DEPLOY_STATUS: ${{ needs.deploy.result }}
        run: |
          if [ -z "$BOT_TOKEN" ]; then
            echo "BOT_TOKEN не задан, пропускаем уведомление"
            exit 0
          fi

          if [ "$DEPLOY_STATUS" = "success" ]; then
            EMOJI="✅"
            TEXT="Деплой ${TAG} завершён успешно"
          else
            EMOJI="❌"
            TEXT="Деплой ${TAG} завершился с ошибкой: ${DEPLOY_STATUS}"
          fi

          MESSAGE="${EMOJI} <b>VkusVill Bot Deploy</b>%0A%0A${TEXT}%0ARepo: ${GITHUB_REPOSITORY}%0ACommit: ${GITHUB_SHA:0:7}"

          curl -s -X POST \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            > /dev/null 2>&1 || true
